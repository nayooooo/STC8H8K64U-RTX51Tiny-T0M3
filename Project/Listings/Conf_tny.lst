A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE     1


MACRO ASSEMBLER A51 V8.02c
OBJECT MODULE PLACED IN ..\Obj\Conf_tny.obj
ASSEMBLER INVOKED BY: D:\Keil_v5\C51\BIN\A51.EXE ..\RTOS\Conf_tny.A51 SET(SMALL) DEBUG PRINT(.\Listings\Conf_tny.lst) OB
                      JECT(..\Obj\Conf_tny.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     $nomod51  DEBUG
                       2     ;------------------------------------------------------------------------------
                       3     ;  This file is part of the RTX-51 TINY  Real-Time Operating System Package
                       4     ;  Copyright KEIL ELEKTRONIK GmbH and Keil Software, Inc. 1991-2002
                       5     ;  Version 2.02
                       6     ;------------------------------------------------------------------------------
                       7     ;  CONF_TNY.A51:  This code allows the configuration of the
                       8     ;                 RTX-51 TINY Real-Time Operating System
                       9     ;
                      10     ;  Copy this file to your project folder and add the copy to your uVision2
                      11     ;  project.  You can customize several parameters of RTX51 Tiny within this
                      12     ;  configuration file.
                      13     ;
                      14     ;  If you use command line tools, translate this file with:
                      15     ;
                      16     ;     Ax51 CONF_TNY.A51
                      17     ;
                      18     ;  If you use command line tools, link the modified CONF_TNY.OBJ file to 
                      19     ;  your application with:
                      20     ;
                      21     ;     Lx51 <your object file list>, CONF_TNY.OBJ <controls>
                      22     ;
                      23     ;------------------------------------------------------------------------------
                      24     ;
                      25     ;  RTX-51 TINY Hardware-Timer
                      26     ;  ==========================
                      27     ;
                      28     ;  With the following EQU statements the initialization of the RTX-51 TINY
                      29     ;  Hardware-Timer can be defined (RTX-51 TINY uses the 8051 Timer 0 for 
                      30     ;  controlling RTX-51 software timers).
                      31     ;
                      32     ;  Define the register bank used for the timer interrupt.
  0001                33     INT_REGBANK     EQU     1       ; default is Registerbank 1
                      34     ;
                      35     ;  Define Hardware-Timer tick time in 8051 machine cycles.
  5DC0                36     INT_CLOCK       EQU     24000   ; default is 24000 cycles
                      37     ;
                      38     ;  Define Round-Robin Timeout in Hardware-Timer ticks.
  0001                39     TIMESHARING     EQU     1       ; default is 1 Hardware-Timer ticks.
                      40     ;                               ; 0 disables Round-Robin Task Switching
                      41     ;
                      42     ;  Long User Interrupt Routines: set to 1 if your application contains 
                      43     ;  user interrupt functions that may take longer than a hardware timer 
                      44     ;  interval for execution.
  0000                45     LONG_USR_INTR   EQU     0       ; 0 user interrupts execute fast.
                      46     ;                               ; 1 user interrupts take long execution times.
                      47     ;
                      48     ;
                      49     ;------------------------------------------------------------------------------
                      50     ;
                      51     ;  USER CODE FOR 8051 HARDWARE TIMER INTERRUPT
                      52     ;  ===========================================
                      53     ;
                      54     ;  The following macro defines the code executed on a hardware timer interrupt.
                      55     ;
                      56     ;  Define instructions executed on a hardware timer interrupt.
                      57     HW_TIMER_CODE   MACRO
A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE     2

                      58                                     ; Empty Macro by default
                      59                     RETI
                      60                     ENDM
                      61     ;
                      62     ;
                      63     ;------------------------------------------------------------------------------
                      64     ;
                      65     ;  CODE BANKING SUPPORT
                      66     ;  ====================
                      67     ;
                      68     ;  The following EQU statement controls the code banking support for RTX51 TINY.
                      69     ;
                      70     ;  Enable or disable code banking support
  0000                71     CODE_BANKING     EQU     0      ; 0 (default) application uses no code banking
                      72     ;                               ; 1 application uses code banking
                      73     ;
                      74     ;------------------------------------------------------------------------------
                      75     ;
                      76     ;  RTX-51 TINY Stack Space
                      77     ;  =======================
                      78     ;
                      79     ;  The following EQU statements defines the size of the internal RAM used
                      80     ;  for stack area and the minimum free space on the stack.  A macro defines
                      81     ;  the code executed when there is there is not enough free stack on the
                      82     ;  CPU stack.
                      83     ;
                      84     ;  Define the highest RAM address used for CPU stack
  00FF                85     RAMTOP          EQU     0FFH    ; default is address (256-1)
                      86     ;
  0014                87     FREE_STACK      EQU     20      ; default is 20 bytes free space on stack
                      88     ;                               ; the value 0 disables stack checking
                      89     ;
                      90     STACK_ERROR     MACRO
                      91                     CLR     EA      ; disable interrupts
                      92                     SJMP    $       ; endless loop if stack space is exhausted
                      93                     ENDM
                      94     ;
                      95     ;
                      96     ;------------------------------------------------------------------------------
                      97     ;
                      98     ;  8051 CPU IDLE CODE
                      99     ;  ==================
                     100     ;
                     101     ;  Many 8051 devices provide an IDLE MODE that reduces power consumption and
                     102     ;  EMC.  The following macro defines the code executed when there is no 
                     103     ;  ready task in the system.  The code must set the CPU into an IDLE MODE
                     104     ;  that stops instruction execution until an 8051 hardware interrupt occurs. 
                     105     ;
                     106     
                     107     ; Disable or Enable CPU_IDLE CODE
  0000               108     CPU_IDLE_CODE   EQU     0       ; 0  CPU_IDLE MACRO is not inserted
                     109                                     ; 1  CPU_IDLE MACRO is executed
                     110     
  0087               111     PCON            DATA    087H    ; Power Control SFR on most 8051 devices
                     112     
                     113     ; Stop CPU execution until hardware interrupt; executed when there is no 
                     114     ; active task in the system. 
                     115     CPU_IDLE        MACRO
                     116                     ORL     PCON,#1 ; set 8051 CPU to IDLE
                     117                     ENDM
                     118     ;
                     119     ;
                     120     ;------------------------------------------------------------------------------
                     121     ;----------------- !!! End of User Configuration Part    !!! ------------------
                     122     ;----------------- !!! Do not modify code sections below !!! ------------------
                     123     ;------------------------------------------------------------------------------
A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE     3

                     124     
                     125     ; SFR Symbols
  00D0               126     PSW     DATA    0D0H
  00E0               127     ACC     DATA    0E0H
  00F0               128     B       DATA    0F0H
  0081               129     SP      DATA    81H
  0082               130     DPL     DATA    82H
  0083               131     DPH     DATA    83H
  0088               132     TCON    DATA    88H
  0089               133     TMOD    DATA    89H
  008A               134     TL0     DATA    8AH
  008B               135     TL1     DATA    8BH
  008C               136     TH0     DATA    8CH
  008D               137     TH1     DATA    8DH
  008E               138     AUXR    DATA    8EH
  00A8               139     IE      DATA    0A8H
                     140     
                     141     ; TCON
  008F               142     TF1     BIT     8FH
  008E               143     TR1     BIT     8EH
  008D               144     TF0     BIT     8DH
  008C               145     TR0     BIT     8CH
  008B               146     IE1     BIT     8BH
  008A               147     IT1     BIT     8AH
  0089               148     IE0     BIT     89H
  0088               149     IT0     BIT     88H
                     150     ; IE 
  00AF               151     EA      BIT     0AFH
  00AC               152     ES      BIT     0ACH
  00AB               153     ET1     BIT     0ABH
  00AA               154     EX1     BIT     0AAH
  00A9               155     ET0     BIT     0A9H
  00A8               156     EX0     BIT     0A8H
                     157     
                     158     ; Check Configuration Values
                     159     
                     160     
                     161                     NAME    ?RTX51_TINY_KERNAL
                     162     
                     163     PUBLIC  ?RTX_CURRENTTASK 
                     164     PUBLIC  ?RTX_RAMTOP
                     165     PUBLIC  os_switch_task
                     166     PUBLIC  ?RTX?SET_ISR
                     167     
                     168     EXTRN   NUMBER (?RTX_MAXTASKN)          ; max Task Number
                     169     
  00FF               170     ?RTX_RAMTOP       EQU   RAMTOP
  A240               171     ?RTX_CLOCK        EQU   -INT_CLOCK
                     172     
  0008               173     ?RTX_REGISTERBANK EQU   INT_REGBANK * 8
----                 174                       DSEG  AT    ?RTX_REGISTERBANK
0008                 175                       DS    2     ; temporary space
000A                 176     ?RTX_SAVEACC:     DS    1
  REG                177     saveacc           EQU   R2    ; for access in interrupt service routine
000B                 178     ?RTX_SAVEPSW:     DS    1
  REG                179     savepsw           EQU   R3    ; for access in interrupt service routine
000C                 180     ?RTX_CURRENTTASK: DS    1
  REG                181     currenttask       EQU   R4    ; for access in interrupt service routine
                     182     
                     183     IF (TIMESHARING <> 0)
000D                 184     ?RTX_ROBINTIME:   DS    1
  REG                185     robintime         EQU   R5    ; for access in interrupt service routine
                     186     ENDIF
                     187     
                     188     IF (CODE_BANKING <> 0)
                             EXTRN   DATA    (?B_CURRENTBANK)
A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE     4

                             EXTRN   CODE    (?B_RESTORE_BANK)
                             ENDIF
                     192     
                     193     
                     194     ;------------------------------------------------
                     195     ; Table of Task Entry Pointers
                     196     ;------------------------------------------------
                     197     PUBLIC  ?RTX_TASKENTRY
                     198     
                     199     ?RTX?TASKENT?S  SEGMENT CODE
----                 200                     RSEG    ?RTX?TASKENT?S
0000                 201     ?RTX_TASKENTRY: DS      2
                     202     
                     203     ;------------------------------------------------
                     204     ; Table of Stack Pointers for each task
                     205     ;------------------------------------------------
                     206     PUBLIC  ?RTX_TASKSP
                     207     
                     208     ?RTX?TASKSP?S   SEGMENT IDATA
----                 209                     RSEG    ?RTX?TASKSP?S
0000                 210     ?RTX_TASKSP:    DS      1
                     211     
                     212     ;------------------------------------------------
                     213     ; Table of Task Timer/State Pointers
                     214     ;------------------------------------------------
                     215     PUBLIC  ?RTX_TASKSTATUS
                     216     
                     217     ?RTX?TASKSTATE?S  SEGMENT IDATA
----                 218                       RSEG    ?RTX?TASKSTATE?S
0000                 219     ?RTX_TASKSTATUS:
0000                 220     TimerVal:       DS      1       ; Task Timer (Software Timer for each task)
0001                 221     TaskState:      DS      1       ; Task Status (state of each Task)
                     222     
                     223     ; Definitions for Bits in Task State
                     224     ;  TaskState.0  = Wait for Signal
                     225     ;  TaskState.1  = Wait for TimeOut
                     226     ;  TaskState.2  = Signal Flag
                     227     ;  TaskState.3  = TimeOut Flag
                     228     ;  TaskState.4  = Task Ready (Wait for Running)
                     229     ;  TaskState.5  = Task Active (enabled with os_create)
                     230     ;  TaskState.6  = Round Robin Time Out
                     231     ;  TaskState.7  = Run Flag
                     232     
                     233     ; byte mask definitions
  0001               234     K_SIG           EQU     1
  0002               235     K_TMO           EQU     2
  0004               236     SIG_EVENT       EQU     4
  0008               237     TMO_EVENT       EQU     8
  0010               238     K_READY         EQU     16
  0020               239     K_ACTIVE        EQU     32
  0040               240     K_ROBIN         EQU     64
  0080               241     K_IVL           EQU     128  ; not a task state bit; only used in os_wait
  0080               242     RDY_EVENT       EQU     128  ; READY status flag
  0080               243     K_RDY           EQU     128
                     244     
                     245     ; bit position definitions
  0000               246     B_WAITSIG       EQU     0
  0001               247     B_WAITTIM       EQU     1
  0002               248     B_SIGNAL        EQU     2
  0003               249     B_TIMEOUT       EQU     3
  0004               250     B_READY         EQU     4
  0005               251     B_ACTIVE        EQU     5
  0006               252     B_ROBIN         EQU     6
  0007               253     B_IVL           EQU     7    ; not a task state bit; only used in os_wait
  0007               254     B_RDY           EQU     7
                     255     
A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE     5

                     256     
                     257     IF (TIMESHARING OR CPU_IDLE_CODE)
                     258     ?RTX?BITS       SEGMENT BIT
----                 259                     RSEG    ?RTX?BITS
                     260     ENDIF
                     261     
                     262     IF (TIMESHARING)
0000                 263     ?RTX_TS_DELAY:  DBIT    1       ; Status bit set when task switch in progress
                     264     ENDIF
                     265     
                     266     IF (CPU_IDLE_CODE)
                             ?RTX_ISR_SIG:   DBIT    1       ; Status bit set when interrupt or os_set_signal
                             ENDIF
                     269     
                     270     
----                 271                     CSEG    AT      0BH
000B 020000   F      272                     JMP     TIMERINT
                     273     
                     274     ?RTX?CODE       SEGMENT CODE
----                 275                     RSEG    ?RTX?CODE
                     276                     USING   0               ; Registerbank 0 for following code
                     277     
                     278     IF (FREE_STACK <> 0)
0000                 279     ?RTX_STACKERROR:
                     280                     STACK_ERROR             ; User defined Stack Error Code
                     283     ENDIF
                     284     
0004                 285     HW_TIMER:       HW_TIMER_CODE
                     288     
0005                 289     TIMERINT:
                     290     
                     291     IF (LONG_USR_INTR)
                                             PUSH    ACC
                                             MOV     A,PSW
                                             ANL     A,#018H
                                             XRL     A,#?RTX_REGISTERBANK
                                             JNZ     CONT_TIMINT
                             ; avoid recursive timer interrupt
                                             POP     ACC
                                             RETI            ; Return from Recursive Timer Interrupt
                             CONT_TIMINT:    POP     ACC
                             
                             ENDIF
                     303     
0005 120000   F      304                     CALL    HW_TIMER        ; Enable Interrupts again.
                     305     
0008 85D00B          306                     MOV     ?RTX_SAVEPSW,PSW
000B 75D008          307                     MOV     PSW,#?RTX_REGISTERBANK
000E AAE0            308                     MOV     saveacc,ACC     ; ACC required by some Cygnal devices
                     309     ;; Update 8051 Interrupt Timer
                     310     ;               CLR     TR0
                     311     ;               MOV     A,TL0
                     312     ;               ADD     A,#LOW (?RTX_CLOCK + 7)
                     313     ;               MOV     TL0,A
                     314     ;               MOV     A,TH0
                     315     ;               ADDC    A,#HIGH (?RTX_CLOCK + 7)
                     316     ;               MOV     TH0,A
                     317     ;               SETB    TR0
                     318     
                     319     IF (FREE_STACK <> 0)
                     320     ; Check if enough free stack is available
0010 EC              321                     MOV     A,currenttask
0011 2400     F      322                     ADD     A,#?RTX?TASKSP?S+1
0013 F8              323                     MOV     R0,A
0014 E6              324                     MOV     A,@R0
0015 BC0002   F      325                     CJNE    currenttask,#?RTX_MAXTASKN,checkstack
A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE     6

0018 74FF            326                     MOV     A,#RAMTOP
001A C3              327     checkstack:     CLR     C
001B 9581            328                     SUBB    A,SP
001D B41400          329                     CJNE    A,#FREE_STACK,$+3
0020 40DE            330                     JC      ?RTX_STACKERROR
                     331     ENDIF
                     332     
                     333     ; Update & Check Task Timers
0022 7900     F      334                     MOV     R1,#?RTX_MAXTASKN+1
0024 7800     F      335                     MOV     R0,#?RTX?TASKSTATE?S
0026 16              336     TIMERLOOP:      DEC     @R0          ; Decrement timer
0027 E6              337                     MOV     A,@R0
0028 08              338                     INC     R0           ; advance to TaskState
0029 700B            339                     JNZ     NoTimeout
002B C2AF            340                     CLR     EA
002D E6              341                     MOV     A,@R0
002E 30E103          342                     JNB     ACC.B_WAITTIM,NoWaitTimeout
0031 4418            343                     ORL     A,#(K_READY+TMO_EVENT)
0033 F6              344                     MOV     @R0,A
0034 D2AF            345     NoWaitTimeout:  SETB    EA
0036 08              346     NoTimeout:      INC     R0           ; advance to TaskTimer
0037 D9ED            347                     DJNZ    R1,TIMERLOOP
                     348     
0039 EA              349                     MOV     A,saveacc
003A 8BD0            350                     MOV     PSW,savepsw
                     351                     USING   0               ; Registerbank 0 for following code
                     352     
                     353     IF (TIMESHARING == 0)
                             ; Round Robin Task Switching not required.  System Interrupt ends here
                             ?RTX?SET_ISR:   
                             IF (CPU_IDLE_CODE)
                                             SETB    ?RTX_ISR_SIG
                             ENDIF
                                             RET     
                             ENDIF
                     361     
                     362     IF (TIMESHARING)
                     363     ; Round Robin Task Switching required.  Check if task generates timeout
                     364     ; Check for Round Robin Timeout on the current task
003C 300001   F      365                     JNB     ?RTX_TS_DELAY,CheckRobinTime
003F                 366     NoRobinTimeout: 
003F                 367     ?RTX?SET_ISR:   
                     368     IF (CPU_IDLE_CODE)
                                             SETB    ?RTX_ISR_SIG
                             ENDIF
003F 22              371                     RET     
0040 D50DFC          372     CheckRobinTime: DJNZ     ?RTX_ROBINTIME,NoRobinTimeout
                     373     
0043                 374     ?RTX_TASKSWITCHING:
0043 C0E0            375                     PUSH    ACC
0045 C0D0            376                     PUSH    PSW
0047 C0F0            377                     PUSH    B
0049 C083            378                     PUSH    DPH
004B C082            379                     PUSH    DPL
004D C000            380                     PUSH    AR0
004F C001            381                     PUSH    AR1
0051 C002            382                     PUSH    AR2
0053 C003            383                     PUSH    AR3
0055 C004            384                     PUSH    AR4
0057 C005            385                     PUSH    AR5
0059 C006            386                     PUSH    AR6
005B C007            387                     PUSH    AR7
                     388     IF (CODE_BANKING <> 0)
                                             PUSH    ?B_CURRENTBANK
                             ENDIF
                     391     
A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE     7

005D E50C            392                     MOV     A,?RTX_CURRENTTASK
005F 23              393                     RL      A
0060 2400     F      394                     ADD     A,#?RTX?TASKSTATE?S+1
0062 F8              395                     MOV     R0,A
0063 7440            396                     MOV     A,#K_ROBIN
0065 C2AF            397                     CLR     EA
0067 46              398                     ORL     A,@R0
0068 F6              399                     MOV     @R0,A
0069 D2AF            400                     SETB    EA
                     401     IF (CODE_BANKING <> 0)
                                             SJMP    os_switch_task1
                             ENDIF
                     404     ENDIF
                     405     
                     406     ;------------------------------------------------
                     407     ; Perform a Task-Switch
                     408     ;  void os_switch_task (void)
                     409     ;      uchar i;
                     410     ;      uchar limit;
                     411     
                     412     ;---- Variable 'current' assigned to Register 'R6' ----
                     413     ;---- Variable 'next' assigned to Register 'R7' ----
                     414     ;---- Variable 'i' assigned to Register 'R0' ----
                     415     ;---- Variable 'limit' assigned to Register 'R5' ----
                     416     ;
                     417     ;------------------------------------------------
                     418     
006B                 419     os_switch_task:
                     420     
                     421     IF (CODE_BANKING <> 0)
                                             PUSH    ?B_CURRENTBANK
                             ENDIF
                     424     
006B                 425     os_switch_task1:
                     426     
                     427     ;      next = current;
                     428     IF (TIMESHARING <> 0)
006B D200     F      429                     SETB    ?RTX_TS_DELAY           ; Delay Task Switching
                     430     ENDIF
006D E50C            431                     MOV     A,?RTX_CURRENTTASK
006F FF              432                     MOV     R7,A
                     433     ;      while (1)  {
0070 23              434                     RL      A
0071 2400     F      435                     ADD     A,#?RTX?TASKSTATE?S+1
0073 F8              436                     MOV     R0,A
0074                 437     ?C0001:
                     438     ;        if (++next == MAXTASKN+1)  next = 0;
0074 0F              439                     INC     R7
0075 08              440                     INC     R0
0076 08              441                     INC     R0
                     442     IF (CPU_IDLE_CODE)
                                             MOV     A,R7
                                             CJNE    A,?RTX_CURRENTTASK,NoIDLE
                                             JBC     ?RTX_ISR_SIG,NoIDLE
                                             CPU_IDLE          ; CPU sleep
                             NoIDLE:
                             ENDIF
0077 BF0004   F      449                     CJNE    R7,#?RTX_MAXTASKN+1,?C0003
007A 7F00            450                     MOV     R7,#0
007C 7800     F      451                     MOV     R0,#?RTX?TASKSTATE?S+1
007E                 452     ?C0003:
                     453     ;        if (STATE[next].st & K_READY)  break;
007E E6              454                     MOV     A,@R0
007F 30E4F2          455                     JNB     ACC.B_READY,?C0001
                     456     ;      }
                     457     ;
A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE     8

                     458     
                     459     PUBLIC  ?RTX_NEXTID
                     460     PUBLIC  ?RTX_NEXTTASK
                     461     
  0007               462     ?RTX_NEXTID     EQU     AR7
0082 00              463     ?RTX_NEXTTASK:  NOP             ; for Debugging
                     464     
                     465     ;      while (current < next)  {
0083                 466     ?C0005:
0083 E50C            467                     MOV     A,?RTX_CURRENTTASK
0085 C3              468                     CLR     C
0086 9F              469                     SUBB    A,R7
0087 5020            470                     JNC     ?C0011
                     471     
                     472     ;        current++;
0089 050C            473                     INC     ?RTX_CURRENTTASK
                     474     ;        i = STKP[current];
008B 7400     F      475                     MOV     A,#?RTX?TASKSP?S
008D 250C            476                     ADD     A,?RTX_CURRENTTASK
008F F8              477                     MOV     R0,A
0090 E6              478                     MOV     A,@R0
0091 FD              479                     MOV     R5,A
                     480     ;        STKP[current] = SP;
0092 A681            481                     MOV     @R0,SP
                     482     ;        if (current == MAXTASKN) limit = RAMTOP;
0094 08              483                     INC     R0
0095 E6              484                     MOV     A,@R0
0096 AE0C            485                     MOV     R6,?RTX_CURRENTTASK
0098 BE0002   F      486                     CJNE    R6,#?RTX_MAXTASKN,?C0007
009B 74FF            487                     MOV     A,#RAMTOP
009D                 488     ?C0007:
009D CD              489                     XCH     A,R5
009E F8              490                     MOV     R0,A
                     491     ;        else                       limit = STKP[current+1];
                     492     ;
                     493     ;        while (i != limit)  {
009F                 494     ?C0009:
009F E8              495                     MOV     A,R0
00A0 6D              496                     XRL     A,R5
00A1 60E0            497                     JZ      ?C0005
                     498     ;          SP++;
                     499     ;          i++;
                     500     ;          STACK[SP] = STACK[i];
00A3 08              501                     INC     R0
00A4 E6              502                     MOV     A,@R0
00A5 C0E0            503                     PUSH    ACC
00A7 80F6            504                     SJMP    ?C0009
                     505     ;        }
                     506     ;      }
00A9                 507     ?C0011:
                     508     ;
                     509     ;      while (current > next)  {
00A9 E50C            510                     MOV     A,?RTX_CURRENTTASK
00AB D3              511                     SETB    C
00AC 9F              512                     SUBB    A,R7
00AD 4027            513                     JC      ?C0012
                     514             
00AF E50C            515                     MOV     A,?RTX_CURRENTTASK
00B1 2400     F      516                     ADD     A,#?RTX?TASKSP?S+1
00B3 F8              517                     MOV     R0,A
00B4 E6              518                     MOV     A,@R0
                     519     ;        if (current == (MAXTASKN)) i = RAMTOP;
                     520     ;        else                       i = STKP[current+1];
00B5 AE0C            521                     MOV     R6,?RTX_CURRENTTASK
00B7 BE0002   F      522                     CJNE    R6,#?RTX_MAXTASKN,?C0013
00BA 74FF            523                     MOV     A,#RAMTOP
A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE     9

00BC                 524     ?C0013:
00BC FD              525                     MOV     R5,A
                     526     ;        limit = STKP[current];
00BD 18              527                     DEC     R0
00BE E6              528                     MOV     A,@R0
00BF CD              529                     XCH     A,R5
00C0 F8              530                     MOV     R0,A
                     531     ;
                     532     ;        while (SP != limit)  {
00C1                 533     ?C0015:
00C1 E581            534                     MOV     A,SP
00C3 6D              535                     XRL     A,R5
00C4 6006            536                     JZ      ?C0016
                     537     ;          STACK[i] = STACK[SP];
                     538     ;          i--;
                     539     ;          SP--;
00C6 D0E0            540                     POP     ACC
00C8 F6              541                     MOV     @R0,A
00C9 18              542                     DEC     R0
                     543     
00CA 80F5            544                     SJMP    ?C0015
00CC                 545     ?C0016:
                     546     ;        }
                     547     ;        STKP[current] = i;
00CC E50C            548                     MOV     A,?RTX_CURRENTTASK
00CE 2400     F      549                     ADD     A,#?RTX?TASKSP?S
00D0 C8              550                     XCH     A,R0
00D1 F6              551                     MOV     @R0,A
                     552     ;        current--;
00D2 150C            553                     DEC     ?RTX_CURRENTTASK
00D4 80D3            554                     SJMP    ?C0011
00D6                 555     ?C0012:
                     556     ;      }
                     557     
                     558     ;      RoundRobinTime = ?RTX_TIMESHARING
                     559     IF (TIMESHARING)
00D6 750D01          560                     MOV     ?RTX_ROBINTIME,#TIMESHARING
                     561     ENDIF
                     562              
                     563     ;       if (STATE[current].st & K_ROBIN)  goto RobinOn;
00D9 E50C            564                     MOV     A,?RTX_CURRENTTASK
00DB 23              565                     RL      A
00DC 2400     F      566                     ADD     A,#?RTX?TASKSTATE?S+1
00DE F8              567                     MOV     R0,A
00DF 7F04            568                     MOV     R7,#SIG_EVENT
00E1 C2AF            569                     CLR     EA
00E3 E6              570                     MOV     A,@R0
                     571     IF (TIMESHARING)
00E4 10E61E          572                     JBC     ACC.B_ROBIN,RobinOn
                     573     ENDIF
                     574     ;       if ((STATE[current].st & K_SIG) && (STATE[current].st & SIG_EVENT)
                     575     ;          goto SignalOn;
00E7 30E003          576                     JNB     ACC.B_WAITSIG,SignalOff
00EA 10E20C          577                     JBC     ACC.B_SIGNAL,SignalOn
00ED                 578     SignalOff:
                     579     ;       if ((STATE[current].st & K_TMO) && (STATE[current].st & TMO_EVENT)
                     580     ;          goto TimeOutOn;
00ED 7F00            581                     MOV     R7,#0           ; No Event
00EF 30E107          582                     JNB     ACC.B_WAITTIM,NoEvent
00F2 30E304          583                     JNB     ACC.B_TIMEOUT,NoEvent
00F5                 584     TimeOutOn:      
00F5 7F08            585                     MOV     R7,#TMO_EVENT
00F7 54F4            586                     ANL     A,#0F4H
00F9                 587     SignalOn:
00F9 547C            588     NoEvent:        ANL     A,#NOT (K_RDY + K_TMO + K_SIG)  ; Clear RDY + Wait bits
00FB C6              589                     XCH     A,@R0
A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE    10

00FC D2AF            590                     SETB    EA
                     591     
00FE 5480            592                     ANL     A,#K_RDY
0100 4207            593                     ORL     AR7,A
                     594     IF (TIMESHARING <> 0)
                     595       IF (CODE_BANKING)
                                             POP     ACC
                                             CALL    ?B_RESTORE_BANK
                               ENDIF
0102 C200     F      599                     CLR     ?RTX_TS_DELAY
0104 22              600                     RET
                     601     ELSE
                               IF (CODE_BANKING)
                                             POP     ACC
                                             JMP     ?B_RESTORE_BANK
                               ENDIF
                                             RET
                             ENDIF
                     608                     
                     609                     
                     610     
                     611     ;------------------------------------------------
                     612     IF (TIMESHARING <> 0)
0105 F6              613     RobinOn:        MOV     @R0,A
0106 D2AF            614                     SETB    EA
                     615     IF (CODE_BANKING)
                                             POP     ACC
                                             CALL    ?B_RESTORE_BANK
                             ENDIF
0108 D007            619                     POP     AR7
010A D006            620                     POP     AR6
010C D005            621                     POP     AR5
010E D004            622                     POP     AR4
0110 D003            623                     POP     AR3
0112 D002            624                     POP     AR2
0114 D001            625                     POP     AR1
0116 D000            626                     POP     AR0
0118 D082            627                     POP     DPL
011A D083            628                     POP     DPH
011C D0F0            629                     POP     B
011E D0D0            630                     POP     PSW
0120 D0E0            631                     POP     ACC
0122 C200     F      632                     CLR     ?RTX_TS_DELAY
0124 22              633                     RET                     ; Restart Task
                     634     ENDIF
                     635     ;    }
                     636     ;  }
                     637     
                     638     
                     639     
                     640     ;------------------------------------------------
                     641     ; Start RTX-51 Tiny Kernel
                     642     ;------------------------------------------------
                     643     
                     644     EXTRN CODE (?C_STARTUP)
                     645     PUBLIC  main
                     646     
0125 7800     F      647     main:           MOV     R0,#?RTX?TASKSP?S
0127 A681            648                     MOV     @R0,SP
0129 7400     F      649                     MOV     A,#?RTX_MAXTASKN
012B 6006            650                     JZ      main2
012D FF              651                     MOV     R7,A
012E 08              652     main1:          INC     R0
012F 76FF            653                     MOV     @R0,#RAMTOP
0131 DFFB            654                     DJNZ    R7,main1
0133 7F00     F      655     main2:          MOV     R7,#?RTX_MAXTASKN+1
A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE    11

0135 E4              656                     CLR     A
0136 7800     F      657                     MOV     R0,#?RTX?TASKSTATE?S
0138 F6              658     main1x:         MOV     @R0,A
0139 08              659                     INC     R0
013A F6              660                     MOV     @R0,A
013B 08              661                     INC     R0
013C DFFA            662                     DJNZ    R7,main1x
013E 7800     F      663                     MOV     R0,#?RTX?TASKSTATE?S+1
0140 7630            664                     MOV     @R0,#K_ACTIVE+K_READY
0142 900000   F      665                     MOV     DPTR,#?RTX?TASKENT?S
0145 7401            666                     MOV     A,#1
0147 93              667                     MOVC    A,@A+DPTR
0148 C0E0            668                     PUSH    ACC
014A E4              669                     CLR     A
014B 93              670                     MOVC    A,@A+DPTR
014C C0E0            671                     PUSH    ACC
                     672     IF (TIMESHARING <> 0)
014E 750D01          673                     MOV     ?RTX_ROBINTIME,#TIMESHARING
                     674     ENDIF
0151 C28C            675                     CLR             TR0             ; Õ£÷πº∆ 
0153 5389F0          676                     ANL TMOD,#0F0H
0156 D2A9            677                     SETB    ET0             ; ‘ –Ì÷–∂œ
0158 438903          678                     ORL     TMOD,#03H       ; Timer 0 Mode 3
015B 438E80          679                     ORL AUXR,#80H   ; 1T mode
015E 758A40          680                     MOV     TL0,#LOW (?RTX_CLOCK)
0161 758CA2          681                     MOV     TH0,#HIGH (?RTX_CLOCK)
0164 D28C            682                     SETB    TR0
0166 D2AF            683                     SETB    EA              ; ≤ª ‹EAøÿ÷∆
0168 22              684                     RET             ; Start Task 0
                     685     
                     686     
                     687     ;------------------------------------------------
                     688     
                     689     PUBLIC ?RTX_TASKIDX
0169 00       F      690     ?RTX_TASKIDX:   DB      ?RTX_MAXTASKN           ; for Debugging
                     691     
                     692                     END
A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE    12

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

?C0001 . . . . . .  C ADDR   0074H   R   SEG=?RTX?CODE
?C0003 . . . . . .  C ADDR   007EH   R   SEG=?RTX?CODE
?C0005 . . . . . .  C ADDR   0083H   R   SEG=?RTX?CODE
?C0007 . . . . . .  C ADDR   009DH   R   SEG=?RTX?CODE
?C0009 . . . . . .  C ADDR   009FH   R   SEG=?RTX?CODE
?C0011 . . . . . .  C ADDR   00A9H   R   SEG=?RTX?CODE
?C0012 . . . . . .  C ADDR   00D6H   R   SEG=?RTX?CODE
?C0013 . . . . . .  C ADDR   00BCH   R   SEG=?RTX?CODE
?C0015 . . . . . .  C ADDR   00C1H   R   SEG=?RTX?CODE
?C0016 . . . . . .  C ADDR   00CCH   R   SEG=?RTX?CODE
?C_STARTUP . . . .  C ADDR   -----       EXT
?RTX51_TINY_KERNAL  N NUMB   -----       
?RTX?BITS. . . . .  B SEG    0001H       REL=UNIT
?RTX?CODE. . . . .  C SEG    016AH       REL=UNIT
?RTX?SET_ISR . . .  C ADDR   003FH   R   SEG=?RTX?CODE
?RTX?TASKENT?S . .  C SEG    0002H       REL=UNIT
?RTX?TASKSP?S. . .  I SEG    0001H       REL=UNIT
?RTX?TASKSTATE?S .  I SEG    0002H       REL=UNIT
?RTX_CLOCK . . . .  N NUMB   A240H   A   
?RTX_CURRENTTASK .  D ADDR   000CH   A   
?RTX_MAXTASKN. . .  N ADDR   -----       EXT
?RTX_NEXTID. . . .  D ADDR   0007H   A   
?RTX_NEXTTASK. . .  C ADDR   0082H   R   SEG=?RTX?CODE
?RTX_RAMTOP. . . .  N NUMB   00FFH   A   
?RTX_REGISTERBANK.  N NUMB   0008H   A   
?RTX_ROBINTIME . .  D ADDR   000DH   A   
?RTX_SAVEACC . . .  D ADDR   000AH   A   
?RTX_SAVEPSW . . .  D ADDR   000BH   A   
?RTX_STACKERROR. .  C ADDR   0000H   R   SEG=?RTX?CODE
?RTX_TASKENTRY . .  C ADDR   0000H   R   SEG=?RTX?TASKENT?S
?RTX_TASKIDX . . .  C ADDR   0169H   R   SEG=?RTX?CODE
?RTX_TASKSP. . . .  I ADDR   0000H   R   SEG=?RTX?TASKSP?S
?RTX_TASKSTATUS. .  I ADDR   0000H   R   SEG=?RTX?TASKSTATE?S
?RTX_TASKSWITCHING  C ADDR   0043H   R   SEG=?RTX?CODE
?RTX_TS_DELAY. . .  B ADDR   0000H.0 R   SEG=?RTX?BITS
ACC. . . . . . . .  D ADDR   00E0H   A   
AR0. . . . . . . .  D ADDR   0000H   A   
AR1. . . . . . . .  D ADDR   0001H   A   
AR2. . . . . . . .  D ADDR   0002H   A   
AR3. . . . . . . .  D ADDR   0003H   A   
AR4. . . . . . . .  D ADDR   0004H   A   
AR5. . . . . . . .  D ADDR   0005H   A   
AR6. . . . . . . .  D ADDR   0006H   A   
AR7. . . . . . . .  D ADDR   0007H   A   
AUXR . . . . . . .  D ADDR   008EH   A   
B. . . . . . . . .  D ADDR   00F0H   A   
B_ACTIVE . . . . .  N NUMB   0005H   A   
B_IVL. . . . . . .  N NUMB   0007H   A   
B_RDY. . . . . . .  N NUMB   0007H   A   
B_READY. . . . . .  N NUMB   0004H   A   
B_ROBIN. . . . . .  N NUMB   0006H   A   
B_SIGNAL . . . . .  N NUMB   0002H   A   
B_TIMEOUT. . . . .  N NUMB   0003H   A   
B_WAITSIG. . . . .  N NUMB   0000H   A   
B_WAITTIM. . . . .  N NUMB   0001H   A   
CHECKROBINTIME . .  C ADDR   0040H   R   SEG=?RTX?CODE
CHECKSTACK . . . .  C ADDR   001AH   R   SEG=?RTX?CODE
CODE_BANKING . . .  N NUMB   0000H   A   
CPU_IDLE_CODE. . .  N NUMB   0000H   A   
CURRENTTASK. . . .    REG    R4          
A51 MACRO ASSEMBLER  CONF_TNY                                                             08/03/2022 19:30:45 PAGE    13

DPH. . . . . . . .  D ADDR   0083H   A   
DPL. . . . . . . .  D ADDR   0082H   A   
EA . . . . . . . .  B ADDR   00A8H.7 A   
ES . . . . . . . .  B ADDR   00A8H.4 A   
ET0. . . . . . . .  B ADDR   00A8H.1 A   
ET1. . . . . . . .  B ADDR   00A8H.3 A   
EX0. . . . . . . .  B ADDR   00A8H.0 A   
EX1. . . . . . . .  B ADDR   00A8H.2 A   
FREE_STACK . . . .  N NUMB   0014H   A   
HW_TIMER . . . . .  C ADDR   0004H   R   SEG=?RTX?CODE
IE . . . . . . . .  D ADDR   00A8H   A   
IE0. . . . . . . .  B ADDR   0088H.1 A   
IE1. . . . . . . .  B ADDR   0088H.3 A   
INT_CLOCK. . . . .  N NUMB   5DC0H   A   
INT_REGBANK. . . .  N NUMB   0001H   A   
IT0. . . . . . . .  B ADDR   0088H.0 A   
IT1. . . . . . . .  B ADDR   0088H.2 A   
K_ACTIVE . . . . .  N NUMB   0020H   A   
K_IVL. . . . . . .  N NUMB   0080H   A   
K_RDY. . . . . . .  N NUMB   0080H   A   
K_READY. . . . . .  N NUMB   0010H   A   
K_ROBIN. . . . . .  N NUMB   0040H   A   
K_SIG. . . . . . .  N NUMB   0001H   A   
K_TMO. . . . . . .  N NUMB   0002H   A   
LONG_USR_INTR. . .  N NUMB   0000H   A   
MAIN . . . . . . .  C ADDR   0125H   R   SEG=?RTX?CODE
MAIN1. . . . . . .  C ADDR   012EH   R   SEG=?RTX?CODE
MAIN1X . . . . . .  C ADDR   0138H   R   SEG=?RTX?CODE
MAIN2. . . . . . .  C ADDR   0133H   R   SEG=?RTX?CODE
NOEVENT. . . . . .  C ADDR   00F9H   R   SEG=?RTX?CODE
NOROBINTIMEOUT . .  C ADDR   003FH   R   SEG=?RTX?CODE
NOTIMEOUT. . . . .  C ADDR   0036H   R   SEG=?RTX?CODE
NOWAITTIMEOUT. . .  C ADDR   0034H   R   SEG=?RTX?CODE
OS_SWITCH_TASK . .  C ADDR   006BH   R   SEG=?RTX?CODE
OS_SWITCH_TASK1. .  C ADDR   006BH   R   SEG=?RTX?CODE
PCON . . . . . . .  D ADDR   0087H   A   
PSW. . . . . . . .  D ADDR   00D0H   A   
RAMTOP . . . . . .  N NUMB   00FFH   A   
RDY_EVENT. . . . .  N NUMB   0080H   A   
ROBINON. . . . . .  C ADDR   0105H   R   SEG=?RTX?CODE
ROBINTIME. . . . .    REG    R5          
SAVEACC. . . . . .    REG    R2          
SAVEPSW. . . . . .    REG    R3          
SIGNALOFF. . . . .  C ADDR   00EDH   R   SEG=?RTX?CODE
SIGNALON . . . . .  C ADDR   00F9H   R   SEG=?RTX?CODE
SIG_EVENT. . . . .  N NUMB   0004H   A   
SP . . . . . . . .  D ADDR   0081H   A   
TASKSTATE. . . . .  I ADDR   0001H   R   SEG=?RTX?TASKSTATE?S
TCON . . . . . . .  D ADDR   0088H   A   
TF0. . . . . . . .  B ADDR   0088H.5 A   
TF1. . . . . . . .  B ADDR   0088H.7 A   
TH0. . . . . . . .  D ADDR   008CH   A   
TH1. . . . . . . .  D ADDR   008DH   A   
TIMEOUTON. . . . .  C ADDR   00F5H   R   SEG=?RTX?CODE
TIMERINT . . . . .  C ADDR   0005H   R   SEG=?RTX?CODE
TIMERLOOP. . . . .  C ADDR   0026H   R   SEG=?RTX?CODE
TIMERVAL . . . . .  I ADDR   0000H   R   SEG=?RTX?TASKSTATE?S
TIMESHARING. . . .  N NUMB   0001H   A   
TL0. . . . . . . .  D ADDR   008AH   A   
TL1. . . . . . . .  D ADDR   008BH   A   
TMOD . . . . . . .  D ADDR   0089H   A   
TMO_EVENT. . . . .  N NUMB   0008H   A   
TR0. . . . . . . .  B ADDR   0088H.4 A   
TR1. . . . . . . .  B ADDR   0088H.6 A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
